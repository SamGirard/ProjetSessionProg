-----------------------------CRÉATION DES TABLES-------------------------------
CREATE TABLE employe(
    matricule VARCHAR(10) UNIQUE PRIMARY KEY,
    nom VARCHAR(50),
    prenom VARCHAR(50),
    date_naissance DATE,
    email VARCHAR(150),
    adresse VARCHAR(100),
    date_embauche DATE,
    taux DOUBLE,
    photo VARCHAR(1000),
    statut ENUM('Journalier', 'Permanent')
    );

CREATE TABLE client(
    id_client INTEGER(3) UNIQUE PRIMARY KEY,
    nom VARCHAR(50),
    adresse VARCHAR(100),
    numero_tel VARCHAR(30),
    email VARCHAR(150)
);

CREATE TABLE projet(
    id_projet VARCHAR(11) PRIMARY KEY UNIQUE,
    titre VARCHAR(100),
    date_debut DATE,
    description VARCHAR(255),
    budget DOUBLE,
    nb_employe INT,
    salaireTotal DOUBLE,
    id_client VARCHAR(3),
    statut ENUM('Terminé', 'En cours'),
    CHECK (nb_employe <= 5),
    FOREIGN KEY projet(id_client) REFERENCES client(id_client)
);

-----------------------------TRIGGER---------------------------------

/*Trigger pour le matricule de l'employe*/
DELIMITER  //
CREATE TRIGGER matriculeEmp BEFORE INSERT
    on employe
    FOR EACH ROW
    BEGIN
        SET NEW.matricule = CONCAT(SUBSTRING(NEW.nom, 0, 2), '-', YEAR(NEW.date_naissance), '-', FLOOR(rand()*89) + 10);
    end //
DELIMITER ;

/*Trigger pour l'identifiant du client*/
DELIMITER  //
CREATE TRIGGER identifiantClient BEFORE INSERT
    on client
    FOR EACH ROW
    BEGIN
        SET NEW.idClient = FLOOR(rand()*899) + 100;
    end //
DELIMITER ;


/*Trigger pour le numéro de projet*/
DELIMITER  //
CREATE TRIGGER numeroProjet BEFORE INSERT
    on projet
    FOR EACH ROW
    BEGIN
        SET NEW.numero = CONCAT(UPPER(NEW.client), '-', FLOOR(rand()*89) + 10, '-', YEAR(NEW.date_debut));
    end //
DELIMITER ;

-----------------------------Procédures---------------------------------
DELIMITER //
CREATE PROCEDURE p_ajout_employe(IN matricule VARCHAR(10), IN nom VARCHAR(20), IN prenom VARCHAR(20), IN dateNaiss DATE, IN email VARCHAR(150), IN adresse VARCHAR(100), IN date_embauche DATE, IN taux DOUBLE, IN photo VARCHAR(1000), IN statut VARCHAR(20))
BEGIN
    INSERT into employe VALUES(matricule, nom, prenom, dateNaiss, email, adresse, date_embauche, taux, photo, statut);
end //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE p_ajout_client(IN id VARCHAR(3), IN nom VARCHAR(50), IN adresse VARCHAR(100), IN numero_tel VARCHAR(30), IN email VARCHAR(150))
BEGIN
    INSERT into client VALUES(id, nom, adresse, numero_tel, email);
end //
DELIMITER ;

DELIMITER //
CREATE PROCEDURE p_ajout_projet(IN id VARCHAR(3), IN titre VARCHAR(50), IN date_debut DATE, IN description VARCHAR(255), IN budget DOUBLE, IN nbEmpl INT, IN salairTot DOUBLE, IN id_client VARCHAR(3), IN statut VARCHAR(20))
BEGIN
    INSERT into client VALUES(id, titre, date_debut, description, budget, nbEmpl, salairTot, id_client, statut);
end //
DELIMITER ;


